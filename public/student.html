<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìñ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background: #f8f9fa; font-family: 'Sarabun', sans-serif; }
    .card { border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    img.thumb { width: 60px; height: auto; border-radius: 6px; cursor: pointer; }
    .card-green { background-color:#28a745; color:white; }
    .card-red { background-color:#dc3545; color:white; }
    .card-yellow { background-color:#ffc107; color:black; }
    .card-gray { background-color:#6c757d; color:white; }
    .card-blue { background-color:#0d6efd; color:white; }
    .card-purple { background-color:#6f42c1; color:white; }
  </style>
</head>
<body class="p-3">

  <div id="headerMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">üìñ Student</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="student.html">üìñ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-warning" href="index.html">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Dashboard</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  
    <h4 class="text-center mb-4">üìñ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
  </div>
  <div id="loadingBox" class="text-center my-4 d-none">
    <div class="spinner-border text-primary"></div>
    <div class="mt-2 text-primary fw-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>

  <div id="studentInfo" class="text-center mb-3 fw-bold d-none"></div> 
  <div id="logoutBox" class="text-center mb-3 d-none">
    <button class="btn btn-danger btn-sm" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <div id="searchBox" class="mb-3 d-none">
    <div class="input-group w-75 mx-auto">
      <input type="text" id="studentIdInput" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
      <button class="btn btn-primary" type="button" onclick="searchStudent()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>
  </div>

  <!-- Cards -->
  <div id="summaryCards" class="row row-cols-2 g-2 mb-4 d-none">
    <div class="col"><div class="card card-green p-3 text-center"><h6>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h6><h4 id="presentCount">0</h4></div></div>
    <div class="col"><div class="card card-gray p-3 text-center"><h6>‡∏°‡∏≤‡∏™‡∏≤‡∏¢</h6><h4 id="lateCount">0</h4></div></div>
    <div class="col"><div class="card card-red p-3 text-center"><h6>‡∏Ç‡∏≤‡∏î</h6><h4 id="absentCount">0</h4></div></div>
    <div class="col"><div class="card card-yellow p-3 text-center"><h6>‡∏•‡∏≤‡∏Å‡∏¥‡∏à</h6><h4 id="leavePersonalCount">0</h4></div></div>
    <div class="col"><div class="card card-yellow p-3 text-center"><h6>‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</h6><h4 id="leaveSickCount">0</h4></div></div>
    <div class="col"><div class="card card-purple p-3 text-center"><h6>‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô</h6><h4 id="checkoutCount">0</h4></div></div>
  </div>

  <!-- Today status -->
  <div id="todayStatus" class="card p-3 mb-4 d-none">
    <h6 class="mb-2">üìÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h6>
    <p id="todayText" class="fw-bold"></p>
    <img id="todayImage" src="" alt="" class="img-fluid rounded d-none">
  </div>

  <!-- History -->
  <div id="historyCard" class="card p-3 d-none">
    <h6 class="mb-3">üìå ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6>
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead class="table-dark">
          <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏£‡∏π‡∏õ</th>
          </tr>
        </thead>
        <tbody id="historyTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-body text-center">
          <img id="modalImage" src="" class="img-fluid rounded">
        </div>
      </div>
    </div>
  </div>

<script>
  const SHEET_CHECKIN_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZxpYQHOqzmY_XxPwZUwqBIROIKI-O5aZi7prCkI_TqgYGhLQ9IJQMKON8QpgzPiaf7RkQErLoMKzE/pub?gid=0&single=true&output=csv";
  const SHEET_STUDENT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZxpYQHOqzmY_XxPwZUwqBIROIKI-O5aZi7prCkI_TqgYGhLQ9IJQMKON8QpgzPiaf7RkQErLoMKzE/pub?gid=1824674320&single=true&output=csv";

  let allCheckin = [], allStudents = [];
  let currentSid = null;

  // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏ä‡∏ß‡πå/‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î
  function setLoading(show) {
    const box = document.getElementById("loadingBox");
    if (!box) return;
    if (show) box.classList.remove("d-none");
    else box.classList.add("d-none");
  }
  
  function normalizeId(id) {
    return (id || "").toString().trim().replace(/^0+/, ""); 
  }

  function loadSheets(callback) {
    Promise.all([
      fetch(SHEET_CHECKIN_URL).then(res => res.text()),
      fetch(SHEET_STUDENT_URL).then(res => res.text())
    ]).then(([checkinCsv, studentCsv]) => {
      allCheckin = Papa.parse(checkinCsv, {header:true}).data;
      allStudents = Papa.parse(studentCsv, {header:true}).data;
      if(callback) callback();
    });
  }

  function showImage(src) {
    document.getElementById("modalImage").src = src;
    let modal = new bootstrap.Modal(document.getElementById("imageModal"));
    modal.show();
  }

  function isAbsent(studentId, classroom, date) {
    let classmatesToday = allCheckin.filter(r =>
      (r["‡∏ä‡∏±‡πâ‡∏ô"]||"").trim() === classroom &&
      (r["Timestamp"]||"").startsWith(date)
    );
    if (classmatesToday.length === 0) return false;
    let studentToday = classmatesToday.find(r => normalizeId(r["Student ID"]) === normalizeId(studentId));
    return !studentToday;
  }

  function updateStudentDashboard(studentId) {
    currentSid = normalizeId(studentId);
    let student = allStudents.find(s => normalizeId(s["student_id"]) === currentSid);
    if(!student) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ"); return; }

    let records = allCheckin.filter(r => normalizeId(r["Student ID"]) === currentSid);

    document.getElementById("studentInfo").innerText = 
      `${student["prefix"]||""} ${student["fname"]||""} ${student["lname"]||""} | ‡∏´‡πâ‡∏≠‡∏á ${student["classroom"]||""} ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${student["number"]||""}`;
    document.getElementById("studentInfo").classList.remove("d-none");
    document.getElementById("summaryCards").classList.remove("d-none");
    document.getElementById("todayStatus").classList.remove("d-none");
    document.getElementById("historyCard").classList.remove("d-none");

    let statusCount = {present:0, late:0, absent:0, leavePersonal:0, leaveSick:0, checkout:0};
    let dates = [...new Set(allCheckin.map(r => (r["Timestamp"]||"").split(" ")[0]))];

    dates.forEach(date => {
      let dayRecords = records.filter(r => (r["Timestamp"]||"").startsWith(date));
      if(dayRecords.length > 0) {
        let first = dayRecords[0];
        let st = (first["Status"]||"").trim();
        if(st.includes("‡∏°‡∏≤‡∏™‡∏≤‡∏¢")) { statusCount.late++; statusCount.present++; }
        else if(st.includes("‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥") || st.includes("‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")) { statusCount.present++; }
        else if(st.includes("‡∏•‡∏≤‡∏Å‡∏¥‡∏à")) { statusCount.leavePersonal++; }
        else if(st.includes("‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢")) { statusCount.leaveSick++; }
        dayRecords.forEach(r => { if((r["Status"]||"").includes("‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô")) statusCount.checkout++; });
      } else {
        if(isAbsent(studentId, student["classroom"], date)) statusCount.absent++;
      }
    });

    document.getElementById("presentCount").innerText = statusCount.present;
    document.getElementById("lateCount").innerText = statusCount.late;
    document.getElementById("absentCount").innerText = statusCount.absent;
    document.getElementById("leavePersonalCount").innerText = statusCount.leavePersonal;
    document.getElementById("leaveSickCount").innerText = statusCount.leaveSick;
    document.getElementById("checkoutCount").innerText = statusCount.checkout;

    // Today status
    let today = new Date().toISOString().split("T")[0];
    let todayRecord = records.find(r => (r["Timestamp"]||"").startsWith(today));
    let todayText = document.getElementById("todayText");
    let todayImg = document.getElementById("todayImage");

    if(todayRecord) {
      todayText.innerText = `${todayRecord["Status"]} ‡πÄ‡∏ß‡∏•‡∏≤ ${todayRecord["Time"]}`;
      if(todayRecord["image_link"]) {
        todayImg.src = todayRecord["image_link"];
        todayImg.classList.remove("d-none");
        todayImg.onclick = () => showImage(todayRecord["image_link"]);
      }
    } else if(isAbsent(studentId, student["classroom"], today)) {
      todayText.innerText = "‚ùå ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
      todayImg.classList.add("d-none");
    } else {
      todayText.innerText = "‚ùå ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠";
      todayImg.classList.add("d-none");
    }

    // History
    let tbody = document.getElementById("historyTable");
    tbody.innerHTML = "";
    records.sort((a,b) => new Date(b["Timestamp"]) - new Date(a["Timestamp"]))
           .forEach(r => {
      let date = (r["Timestamp"]||"").split(" ")[0];
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${date}</td>
        <td>${r["Time"]||""}</td>
        <td>${r["Status"]||""}</td>
        <td>${r["image_link"] ? `<img src="${r["image_link"]}" class="thumb" onclick="showImage('${r["image_link"]}')">` : ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function logout(){
    window.location.href = "login.html?logout=1";
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  function searchStudent() {
    const studentId = document.getElementById("studentIdInput").value.trim();
    if(studentId) {
      updateStudentDashboard(studentId);
    } else {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
    }
  }

  document.getElementById("studentIdInput").addEventListener("keypress", e => {
    if(e.key === "Enter") updateStudentDashboard(e.target.value.trim());
  });

  const urlParams = new URLSearchParams(window.location.search);
  const sid = urlParams.get("sid");
  const fromLogin = urlParams.get("from");

  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ login ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î CSV)
  if (fromLogin === "login") {
    document.getElementById("searchBox").classList.add("d-none");
    document.getElementById("logoutBox").classList.remove("d-none");
    document.getElementById("headerMenu").classList.add("d-none");
  }

  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ sid ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if (sid) setLoading(true);

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
  loadSheets(() => {
    if (sid) {
      updateStudentDashboard(sid);
      setLoading(false);   // ‚¨ÖÔ∏è ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à
    } else {
      setLoading(false);   // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏£‡∏á ‡πÜ ‡πÑ‡∏°‡πà‡∏°‡∏µ sid
      document.getElementById("headerMenu").classList.remove("d-none");
      document.getElementById("searchBox").classList.remove("d-none");
    }
  });

  // (‡∏Ñ‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ)
  setInterval(loadSheets, 30000);
</script>

</body>
</html>
